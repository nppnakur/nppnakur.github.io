<script>
// EmailJS Configuration
const SERVICE_ID = "service_25eenak";
const TEMPLATE_ID = "template_hdj6nfo";
const PUBLIC_KEY = "M-JV2m_vTtrU3W_EB";
const ADMIN_EMAIL = "sunnydhaka91@gmail.com";

// Global variables
let generatedOTP = null;
let otpTimer = null;
let timeLeft = 300;
let deferredPrompt = null;
let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
let isAndroid = /Android/.test(navigator.userAgent);

// DOM рд▓реЛрдб рд╣реЛрдиреЗ рдкрд░
document.addEventListener('DOMContentLoaded', function() {
    console.log('ЁЯЪА NAGAR PALIKA PWA рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...');
    
    // PWA рдлреАрдЪрд░реНрд╕ рдбрд┐рдЯреЗрдХреНрдЯ
    detectPWAFeatures();
    
    // PWA рдЗрдВрд╕реНрдЯреЙрд▓ рдЗрд╡реЗрдВрдЯ
    setupInstallPrompt();
    
    // рд╕рд░реНрд╡рд┐рд╕ рд╡рд░реНрдХрд░ рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░реЗрдВ
    registerServiceWorker();
    
    // рдмреЗрд╕рд┐рдХ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬреЗрд╢рди
    initializeApp();
});

// PWA рдлреАрдЪрд░реНрд╕ рдбрд┐рдЯреЗрдХреНрдЯ
function detectPWAFeatures() {
    console.log('ЁЯУ▒ рдбрд┐рд╡рд╛рдЗрд╕ рдбрд┐рдЯреЗрдХреНрд╢рди:');
    console.log('- iOS:', isIOS);
    console.log('- Android:', isAndroid);
    console.log('- Standalone:', window.matchMedia('(display-mode: standalone)').matches);
    console.log('- BeforeInstallPrompt:', 'beforeinstallprompt' in window);
    console.log('- Service Worker:', 'serviceWorker' in navigator);
}

// PWA рдЗрдВрд╕реНрдЯреЙрд▓ рдкреНрд░реЙрдореНрдкреНрдЯ рд╕реЗрдЯрдЕрдк
function setupInstallPrompt() {
    window.addEventListener('beforeinstallprompt', (e) => {
        console.log('ЁЯУ▒ beforeinstallprompt рдЗрд╡реЗрдВрдЯ рдЯреНрд░рд┐рдЧрд░');
        e.preventDefault();
        deferredPrompt = e;
        
        // рд╢реЛ рдЗрдВрд╕реНрдЯреЙрд▓ рдмрдЯрди
        showInstallButton();
        
        // рдбреЗрдореЛ рдХреЗ рд▓рд┐рдП: рдСрдЯреЛ рд╢реЛ рдкреНрд░реЙрдореНрдкреНрдЯ (5 рд╕реЗрдХрдВрдб рдмрд╛рдж)
        setTimeout(() => {
            if (deferredPrompt) {
                showInstallPrompt();
            }
        }, 5000);
    });
    
    // PWA рдкрд╣рд▓реЗ рд╕реЗ рдЗрдВрд╕реНрдЯреЙрд▓ рд╣реИ рдХреНрдпрд╛?
    window.addEventListener('appinstalled', (evt) => {
        console.log('ЁЯОЙ PWA рдЗрдВрд╕реНрдЯреЙрд▓ рд╣реЛ рдЧрдпрд╛!');
        deferredPrompt = null;
        hideInstallPrompt();
        showNotification('рдирдЧрд░ рдкрд╛рд▓рд┐рдХрд╛ рдРрдк рдЗрдВрд╕реНрдЯреЙрд▓ рд╣реЛ рдЧрдпрд╛!');
    });
}

// рдЗрдВрд╕реНрдЯреЙрд▓ рдмрдЯрди рджрд┐рдЦрд╛рдПрдВ
function showInstallButton() {
    const installBtn = document.getElementById('installBtn');
    if (installBtn) {
        installBtn.style.display = 'inline-block';
    }
}

// iOS рдХреЗ рд▓рд┐рдП рдореИрдиреНрдпреБрдЕрд▓ рдЗрдВрд╕реНрдЯреЙрд▓ рдЧрд╛рдЗрдб
function showIOSInstallGuide() {
    const guideHTML = `
    <div id="iosInstallGuide" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 9999;
        color: white;
        padding: 20px;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    ">
        <h2 style="color: #ffcc00;">ЁЯУ▒ iOS рдкрд░ рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░реЗрдВ</h2>
        <div style="background: rgba(255,204,0,0.1); padding: 20px; border-radius: 10px; margin: 20px; max-width: 400px;">
            <p style="font-size: 18px; margin-bottom: 20px;">рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реНрдЯреЗрдкреНрд╕ рдлреЙрд▓реЛ рдХрд░реЗрдВ:</p>
            <div style="text-align: left; margin: 20px;">
                <p>1. <strong>Safari рдмреНрд░рд╛рдЙрдЬрд╝рд░</strong> рдореЗрдВ рдУрдкрди рдХрд░реЗрдВ</p>
                <p>2. <strong>рд╢реЗрдпрд░ рдмрдЯрди</strong> ЁЯСЖ рдЯреИрдк рдХрд░реЗрдВ</p>
                <p>3. <strong>"рд╣реЛрдо рд╕реНрдХреНрд░реАрди рдкрд░ рдРрдб рдХрд░реЗрдВ"</strong> рд╕реЗрд▓реЗрдХреНрдЯ рдХрд░реЗрдВ</p>
                <p>4. <strong>"рдРрдб"</strong> рдмрдЯрди рдЯреИрдк рдХрд░реЗрдВ</p>
            </div>
            <img src="https://img.icons8.com/ios/100/ffcc00/iphone-home.png" style="width: 80px; margin: 20px;">
        </div>
        <button onclick="closeIOSGuide()" style="
            background: #ffcc00;
            color: black;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            margin-top: 20px;
            cursor: pointer;
        ">
            рд╕рдордЭ рдЧрдпрд╛
        </button>
    </div>`;
    
    document.body.insertAdjacentHTML('beforeend', guideHTML);
}

function closeIOSGuide() {
    const guide = document.getElementById('iosInstallGuide');
    if (guide) {
        guide.remove();
    }
}

// Android рдХреЗ рд▓рд┐рдП рдореИрдиреНрдпреБрдЕрд▓ рдЗрдВрд╕реНрдЯреЙрд▓ рдЧрд╛рдЗрдб
function showAndroidInstallGuide() {
    const guideHTML = `
    <div id="androidInstallGuide" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 9999;
        color: white;
        padding: 20px;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    ">
        <h2 style="color: #ffcc00;">ЁЯУ▒ Android рдкрд░ рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░реЗрдВ</h2>
        <div style="background: rgba(255,204,0,0.1); padding: 20px; border-radius: 10px; margin: 20px; max-width: 400px;">
            <p style="font-size: 18px; margin-bottom: 20px;">рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реНрдЯреЗрдкреНрд╕ рдлреЙрд▓реЛ рдХрд░реЗрдВ:</p>
            <div style="text-align: left; margin: 20px;">
                <p>1. <strong>Chrome рдмреНрд░рд╛рдЙрдЬрд╝рд░</strong> рдореЗрдВ рдУрдкрди рдХрд░реЗрдВ</p>
                <p>2. <strong>рдереНрд░реА рдбреЙрдЯреНрд╕ рдореЗрдиреВ</strong> тЛо рдЯреИрдк рдХрд░реЗрдВ</p>
                <p>3. <strong>"рдЗрдВрд╕реНрдЯреЙрд▓ рдРрдк"</strong> рдпрд╛ <strong>"рдРрдб рдЯреВ рд╣реЛрдорд╕реНрдХреНрд░реАрди"</strong> рд╕реЗрд▓реЗрдХреНрдЯ рдХрд░реЗрдВ</p>
                <p>4. <strong>"рдЗрдВрд╕реНрдЯреЙрд▓"</strong> рдмрдЯрди рдЯреИрдк рдХрд░реЗрдВ</p>
            </div>
            <img src="https://img.icons8.com/ios/100/ffcc00/android-os.png" style="width: 80px; margin: 20px;">
        </div>
        <button onclick="closeAndroidGuide()" style="
            background: #ffcc00;
            color: black;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            margin-top: 20px;
            cursor: pointer;
        ">
            рд╕рдордЭ рдЧрдпрд╛
        </button>
    </div>`;
    
    document.body.insertAdjacentHTML('beforeend', guideHTML);
}

function closeAndroidGuide() {
    const guide = document.getElementById('androidInstallGuide');
    if (guide) {
        guide.remove();
    }
}

// PWA рдЗрдВрд╕реНрдЯреЙрд▓ рдкреНрд░реЙрдореНрдкреНрдЯ рджрд┐рдЦрд╛рдПрдВ
function showInstallPrompt() {
    if (isIOS) {
        // iOS рдХреЗ рд▓рд┐рдП рдореИрдиреНрдпреБрдЕрд▓ рдЧрд╛рдЗрдб
        showIOSInstallGuide();
        return;
    }
    
    if (isAndroid && !deferredPrompt) {
        // Android рдкрд░ рдореИрдиреНрдпреБрдЕрд▓ рдЧрд╛рдЗрдб
        showAndroidInstallGuide();
        return;
    }
    
    // Standard PWA install prompt
    if (deferredPrompt && !isPWAInstalled()) {
        const prompt = document.getElementById('installPrompt');
        if (prompt) {
            prompt.style.display = 'flex';
            prompt.innerHTML = `
                <p>ЁЯУ▒ рдирдЧрд░ рдкрд╛рд▓рд┐рдХрд╛ рдРрдк рдХреЛ рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░реЗрдВ!</p>
                <p><small>рд╣реЛрдо рд╕реНрдХреНрд░реАрди рдкрд░ рдРрдб рдХрд░реЗрдВ рдФрд░ рдСрдлрд▓рд╛рдЗрди рдХрд╛рдо рдХрд░реЗрдВ</small></p>
                <div>
                    <button id="installBtnNow">рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░реЗрдВ</button>
                    <button id="cancelInstallNow" class="secondary">рдмрд╛рдж рдореЗрдВ</button>
                </div>
            `;
            
            // рдирдП рдмрдЯрдиреНрд╕ рдХреЗ рд▓рд┐рдП рдЗрд╡реЗрдВрдЯ рд▓рд┐рд╕рдирд░реНрд╕
            setTimeout(() => {
                const installBtnNow = document.getElementById('installBtnNow');
                const cancelBtnNow = document.getElementById('cancelInstallNow');
                
                if (installBtnNow) {
                    installBtnNow.addEventListener('click', installPWA);
                }
                if (cancelBtnNow) {
                    cancelBtnNow.addEventListener('click', hideInstallPrompt);
                }
            }, 100);
        }
    }
}

// PWA рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░реЗрдВ
async function installPWA() {
    if (!deferredPrompt) {
        if (isIOS) {
            showIOSInstallGuide();
        } else if (isAndroid) {
            showAndroidInstallGuide();
        }
        return;
    }
    
    try {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        
        if (outcome === 'accepted') {
            console.log('тЬЕ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдиреЗ PWA рдЗрдВрд╕реНрдЯреЙрд▓ рд╕реНрд╡реАрдХрд╛рд░ рдХрд┐рдпрд╛');
            showNotification('рдирдЧрд░ рдкрд╛рд▓рд┐рдХрд╛ рдРрдк рдЗрдВрд╕реНрдЯреЙрд▓ рд╣реЛ рдЧрдпрд╛!');
        } else {
            console.log('тЭМ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдиреЗ PWA рдЗрдВрд╕реНрдЯреЙрд▓ рдЕрд╕реНрд╡реАрдХрд╛рд░ рдХрд┐рдпрд╛');
        }
        
        deferredPrompt = null;
        hideInstallPrompt();
        
    } catch (error) {
        console.error('тЭМ рдЗрдВрд╕реНрдЯреЙрд▓ рдкреНрд░реЙрдореНрдкреНрдЯ рдореЗрдВ рддреНрд░реБрдЯрд┐:', error);
        
        // рдлреЙрд▓рдмреИрдХ: рдореИрдиреНрдпреБрдЕрд▓ рдЗрдВрд╕реНрдЯреНрд░рдХреНрд╢рди рджрд┐рдЦрд╛рдПрдВ
        if (isIOS) {
            showIOSInstallGuide();
        } else if (isAndroid) {
            showAndroidInstallGuide();
        }
    }
}

// PWA рдЗрдВрд╕реНрдЯреЙрд▓ рд╣реИ рдпрд╛ рдирд╣реАрдВ
function isPWAInstalled() {
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
    const isIOSStandalone = window.navigator.standalone === true;
    
    if (isStandalone || isIOSStandalone) {
        console.log('ЁЯУ▒ PWA рдкрд╣рд▓реЗ рд╕реЗ рдЗрдВрд╕реНрдЯреЙрд▓ рд╣реИ');
        document.getElementById('pwaBadge').style.display = 'block';
        return true;
    }
    return false;
}

// рд╕рд░реНрд╡рд┐рд╕ рд╡рд░реНрдХрд░ рд░рдЬрд┐рд╕реНрдЯрд░
function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
                console.log('тЬЕ Service Worker registered:', registration.scope);
                
                // PWA рдЗрдВрд╕реНрдЯреЙрд▓ рдмрдЯрди рдЪреЗрдХ
                checkPWAInstallable();
                
            }).catch(error => {
                console.log('тЭМ Service Worker registration failed:', error);
            });
    } else {
        console.log('тЭМ Service Worker рд╕рдкреЛрд░реНрдЯ рдирд╣реАрдВ рд╣реИ');
    }
}

// PWA рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░рдиреЗ рдпреЛрдЧреНрдп рд╣реИ рдХреНрдпрд╛?
function checkPWAInstallable() {
    // рдкреЗрдЬ рд▓реЛрдб рд╣реЛрдиреЗ рдХреЗ 3 рд╕реЗрдХрдВрдб рдмрд╛рдж рдЪреЗрдХ рдХрд░реЗрдВ
    setTimeout(() => {
        if (!deferredPrompt && !isPWAInstalled()) {
            console.log('тД╣я╕П рдСрдЯреЛ рдЗрдВрд╕реНрдЯреЙрд▓ рдкреНрд░реЙрдореНрдкреНрдЯ рдирд╣реАрдВ рдорд┐рд▓рд╛, рдореИрдиреНрдпреБрдЕрд▓ рдСрдкреНрд╢рди рджрд┐рдЦрд╛ рд░рд╣рд╛ рд╣реВрдБ');
            
            // рдореИрдиреНрдпреБрдЕрд▓ рдЗрдВрд╕реНрдЯреЙрд▓ рдмрдЯрди рд╢реЛ рдХрд░реЗрдВ
            const manualInstallBtn = document.createElement('button');
            manualInstallBtn.id = 'manualInstallBtn';
            manualInstallBtn.innerHTML = 'ЁЯУ▒ рдРрдк рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░реЗрдВ';
            manualInstallBtn.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #ffcc00;
                color: #000;
                border: none;
                padding: 12px 20px;
                border-radius: 25px;
                font-weight: bold;
                cursor: pointer;
                z-index: 999;
                box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            `;
            
            manualInstallBtn.addEventListener('click', () => {
                if (isIOS) {
                    showIOSInstallGuide();
                } else if (isAndroid) {
                    showAndroidInstallGuide();
                } else {
                    showInstallPrompt();
                }
            });
            
            document.body.appendChild(manualInstallBtn);
        }
    }, 3000);
}

// рдмреЗрд╕рд┐рдХ рдРрдк рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬреЗрд╢рди
function initializeApp() {
    // рд▓реЛрдЧреЛ рд░рд┐рдлреНрд░реЗрд╢
    const logo = document.getElementById('mainLogo');
    if (logo) {
        logo.src = 'img1.png?' + new Date().getTime();
    }
    
    // рдлреЛрдХрд╕ рдпреВрдЬрд░рдиреЗрдо рдкрд░
    document.getElementById('username').focus();
    
    // рдЗрд╡реЗрдВрдЯ рд▓рд┐рд╕рдирд░реНрд╕
    document.getElementById('loginBtn').addEventListener('click', sendOTP);
    document.getElementById('verifyBtn').addEventListener('click', verifyOTP);
    
    // рдПрдВрдЯрд░ рдХреА рд╕рдкреЛрд░реНрдЯ
    document.getElementById('password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendOTP();
    });
    
    document.getElementById('user-otp').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') verifyOTP();
    });
    
    // рдСрдлрд▓рд╛рдЗрди/рдСрдирд▓рд╛рдЗрди рдбрд┐рдЯреЗрдХреНрд╢рди
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();
    
    // EmailJS рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬ
    emailjs.init(PUBLIC_KEY);
}

// рдиреЗрдЯрд╡рд░реНрдХ рд╕реНрдЯреЗрдЯрд╕ рдЕрдкрдбреЗрдЯ
function updateOnlineStatus() {
    const status = document.getElementById('connectionStatus');
    if (navigator.onLine) {
        status.innerHTML = 'ЁЯФ╡ рдСрдирд▓рд╛рдЗрди';
        status.style.color = '#00ff00';
    } else {
        status.innerHTML = 'ЁЯФ┤ рдСрдлрд▓рд╛рдЗрди';
        status.style.color = '#ff6b6b';
    }
}

// OTP рднреЗрдЬреЗрдВ (рдкрд┐рдЫрд▓рд╛ рдХреЛрдб)
function sendOTP() {
    // ... рдкрд┐рдЫрд▓рд╛ рдХреЛрдб ...
}

// OTP рд╡реЗрд░реАрдлрд╛рдИ рдХрд░реЗрдВ (рдкрд┐рдЫрд▓рд╛ рдХреЛрдб)
function verifyOTP() {
    // ... рдкрд┐рдЫрд▓рд╛ рдХреЛрдб ...
}

// OTP рдлрд┐рд░ рд╕реЗ рднреЗрдЬреЗрдВ (рдкрд┐рдЫрд▓рд╛ рдХреЛрдб)
function resendOTP() {
    // ... рдкрд┐рдЫрд▓рд╛ рдХреЛрдб ...
}

// OTP рдЯрд╛рдЗрдорд░ рд╢реБрд░реВ (рдкрд┐рдЫрд▓рд╛ рдХреЛрдб)
function startOTPTimer() {
    // ... рдкрд┐рдЫрд▓рд╛ рдХреЛрдб ...
}

// рдЗрдирдкреБрдЯ рд╢реЗрдХ рдХрд░реЗрдВ
function shakeInputs() {
    const inputs = document.querySelectorAll('input');
    inputs.forEach(input => {
        input.style.animation = 'shake 0.5s';
        setTimeout(() => input.style.animation = '', 500);
    });
}

// рдиреЛрдЯрд┐рдлрд┐рдХреЗрд╢рди рджрд┐рдЦрд╛рдПрдВ
function showNotification(message) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('NAGAR PALIKA NAKUR', {
            body: message,
            icon: 'img1.png'
        });
    }
}

// рдкреЗрдЬ рдореЗрдВ рд╢реЗрдХ рдПрдиреАрдореЗрд╢рди рдРрдб рдХрд░реЗрдВ
const style = document.createElement('style');
style.textContent = `
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        75% { transform: translateX(10px); }
    }
`;
document.head.appendChild(style);
</script>
