// Parse CSV data with proper column mapping for your specific format
function parseCSV(csvText) {
    const rows = csvText.split('\n');
    const data = [];
    
    // Skip empty rows
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i].trim();
        if (!row) continue;
        
        // Split by comma, but handle quoted fields properly
        const columns = [];
        let currentColumn = '';
        let inQuotes = false;
        
        for (let j = 0; j < row.length; j++) {
            const char = row[j];
            
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                columns.push(currentColumn.trim());
                currentColumn = '';
            } else {
                currentColumn += char;
            }
        }
        columns.push(currentColumn.trim()); // Add last column
        
        // For your specific data format with 8 columns
        if (columns.length >= 8) {
            // Extract data from columns according to your format:
            // Column 0: ‡§ï‡•ç‡§∞‡§Æ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ (like "1034")
            // Column 1: ‡§µ‡§æ‡§∞‡•ç‡§° (like "23-‡§ö‡•å‡§ß‡§∞‡•Ä‡§Ø‡§æ‡§®")
            // Column 2: ‡§®‡§æ‡§Æ (like "‡§∂‡•ç‡§∞‡•Ä ‡§∞‡§ï‡§Æ ‡§∏‡§ø‡§Ç‡§π s/o ‡§∂‡•ç‡§∞‡•Ä ‡§π‡•Ä‡§∞‡§æ")
            // Column 3: ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ (like "58")
            // Column 4: 2024-25 ‡§ï‡§æ ‡§∂‡•á‡§∑ (like "‚Çπ259.00")
            // Column 5: ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ (like "‚Çπ9,92,71,91,983.00")
            // Column 6: 2025-26 ‡§ï‡•Ä ‡§∞‡§æ‡§∂‡§ø (like "‚Çπ9,92,71,91,983.00")
            // Column 7: ‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø (like "‚Çπ9,92,71,91,983.00")
            
            // Extract amounts properly
            const current_2025_26 = extractAmount(columns[6]) || 600;
            const arrear_2024_25 = extractAmount(columns[4]) || 0;
            const old_arrear = extractAmount(columns[5]) || 0;
            const total_balance = extractAmount(columns[7]) || (current_2025_26 + arrear_2024_25 + old_arrear);
            
            const connection = {
                con_no: columns[3] || columns[0] || '', // Use connection number or serial number
                ward_no: columns[1] || '',
                owner_name: columns[2] || '',
                mobile: '', // Mobile number might not be in CSV
                current_2025_26: current_2025_26,
                arrear_2024_25: arrear_2024_25,
                old_arrear: old_arrear,
                total_balance: total_balance,
                serial_no: columns[0] || '',
                status: total_balance === 0 ? 'paid' : 'pending'
            };
            
            data.push(connection);
            console.log('Parsed row:', connection);
        }
    }
    
    console.log(`Parsed ${data.length} rows from CSV`);
    return data;
}

// Load CSV data from file
async function loadCSVData() {
    try {
        const response = await fetch('connection_data.csv');
        if (!response.ok) {
            throw new Error('CSV file not found');
        }
        
        const csvText = await response.text();
        console.log('CSV content (first 500 chars):', csvText.substring(0, 500));
        
        // Check if CSV has header row
        const lines = csvText.split('\n');
        const firstLine = lines[0].trim();
        
        // If first line contains headers, remove it
        let dataStartIndex = 0;
        if (firstLine.includes('‡§ï‡•ç‡§∞‡§Æ') || firstLine.includes('‡§µ‡§æ‡§∞‡•ç‡§°') || firstLine.includes('‡§®‡§æ‡§Æ')) {
            dataStartIndex = 1;
            console.log('Detected header row, skipping');
        }
        
        // Parse from data start index
        const dataLines = lines.slice(dataStartIndex).join('\n');
        connectionData = parseCSV(dataLines);
        currentData = [...connectionData];
        
        // Calculate totals from actual data
        calculateTotalsFromData();
        
        updateStats();
        renderTable();
        
        console.log(`‚úÖ Loaded data from CSV: ${connectionData.length} records`);
        console.log('Sample data:', connectionData[0]);
        
        // Show success message
        showMessage(`CSV ‡§´‡§º‡§æ‡§á‡§≤ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≤‡•ã‡§° ‡§π‡•Å‡§à: ${connectionData.length} ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§®`, 'success');
        
    } catch (error) {
        console.error('Error loading CSV:', error);
        // Try other possible file names
        try {
            const alternativeFiles = ['data.csv', 'connections.csv', 'bills.csv'];
            for (const file of alternativeFiles) {
                try {
                    const response = await fetch(file);
                    if (response.ok) {
                        const csvText = await response.text();
                        const lines = csvText.split('\n');
                        const firstLine = lines[0].trim();
                        
                        let dataStartIndex = 0;
                        if (firstLine.includes('‡§ï‡•ç‡§∞‡§Æ') || firstLine.includes('‡§µ‡§æ‡§∞‡•ç‡§°') || firstLine.includes('‡§®‡§æ‡§Æ')) {
                            dataStartIndex = 1;
                        }
                        
                        const dataLines = lines.slice(dataStartIndex).join('\n');
                        connectionData = parseCSV(dataLines);
                        currentData = [...connectionData];
                        
                        calculateTotalsFromData();
                        updateStats();
                        renderTable();
                        
                        showMessage(`CSV ‡§´‡§º‡§æ‡§á‡§≤ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≤‡•ã‡§° ‡§π‡•Å‡§à: ${connectionData.length} ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® (${file})`, 'success');
                        return;
                    }
                } catch (e) {
                    // Continue to next file
                }
            }
            throw new Error('No CSV files found');
        } catch (e) {
            // Fallback to sample data
            loadSampleData();
        }
    }
}

// Calculate totals from actual data
function calculateTotalsFromData() {
    if (connectionData.length === 0) return;
    
    // Calculate actual totals from loaded data
    const totalCurrent202526 = connectionData.reduce((sum, item) => sum + (item.current_2025_26 || 0), 0);
    const totalArrear202425 = connectionData.reduce((sum, item) => sum + (item.arrear_2024_25 || 0), 0);
    const totalRemaining = connectionData.reduce((sum, item) => sum + (item.total_balance || 0), 0);
    
    console.log('Calculated totals from data:', {
        connections: connectionData.length,
        current: totalCurrent202526,
        arrear: totalArrear202425,
        remaining: totalRemaining
    });
}

// Update statistics display
function updateStats() {
    const totalConnections = currentData.length;
    const totalCurrent = currentData.reduce((sum, item) => sum + (item.current_2025_26 || 0), 0);
    const totalArrear = currentData.reduce((sum, item) => sum + (item.arrear_2024_25 || 0), 0);
    const totalRemaining = currentData.reduce((sum, item) => sum + (item.total_balance || 0), 0);
    
    document.getElementById('totalConnections').textContent = totalConnections.toLocaleString('hi-IN');
    document.getElementById('totalCurrent').textContent = formatIndianCurrency(totalCurrent);
    document.getElementById('totalArrear').textContent = formatIndianCurrency(totalArrear);
    document.getElementById('totalRemaining').textContent = formatIndianCurrency(totalRemaining);
}

// Update table columns to match your CSV format
function renderTable() {
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = '';
    
    if (currentData.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="8" class="no-data">
                    <i class="fas fa-inbox"></i>
                    ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à
                </td>
            </tr>
        `;
        return;
    }
    
    // Update table header to match your CSV structure
    document.querySelectorAll('.data-table thead tr th')[0].textContent = 'üîó ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§®';
    document.querySelectorAll('.data-table thead tr th')[1].textContent = 'üèòÔ∏è ‡§µ‡§æ‡§∞‡•ç‡§°';
    document.querySelectorAll('.data-table thead tr th')[2].textContent = 'üë§ ‡§®‡§æ‡§Æ';
    // Mobile column will be empty for now
    document.querySelectorAll('.data-table thead tr th')[3].textContent = 'üì± ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤/‡§Ö‡§®‡•ç‡§Ø';
    document.querySelectorAll('.data-table thead tr th')[4].textContent = 'üí∞ 2025‚Äë26';
    document.querySelectorAll('.data-table thead tr th')[5].textContent = 'üìÖ 2024‚Äë25';
    document.querySelectorAll('.data-table thead tr th')[6].textContent = 'üßæ ‡§ï‡•Å‡§≤ ‡§∂‡•á‡§∑';
    document.querySelectorAll('.data-table thead tr th')[7].textContent = '‚öôÔ∏è ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ';
    
    // Show first 100 rows for performance
    const displayData = currentData.slice(0, 100);
    
    displayData.forEach((item, index) => {
        const row = document.createElement('tr');
        
        // For mobile/other column, show serial number if available
        const mobileOrSerial = item.mobile || item.serial_no || 'N/A';
        
        row.innerHTML = `
            <td class="con-no-col">${item.con_no || 'N/A'}</td>
            <td class="ward-no-col">${item.ward_no || ''}</td>
            <td class="owner" title="${item.owner_name || ''}">${item.owner_name || ''}</td>
            <td class="mobile-col">${mobileOrSerial}</td>
            <td class="current-amount-col">${formatIndianCurrency(item.current_2025_26 || 0)}</td>
            <td class="arrear-col">${formatIndianCurrency(item.arrear_2024_25 || 0)}</td>
            <td class="total-col">${formatIndianCurrency(item.total_balance || 0)}</td>
            <td class="act">
                <div class="action-buttons">
                    <button class="action-btn edit-btn" onclick="editConnection('${item.con_no}')" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn delete-btn" onclick="showDeleteModal('${item.con_no}', '${item.owner_name}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="action-btn print-btn" onclick="printBill('${item.con_no}')" title="Print">
                        <i class="fas fa-print"></i>
                    </button>
                    ${item.total_balance > 0 ? `
                    <button class="action-btn pay-btn" onclick="makePayment('${item.con_no}')" title="Pay Now">
                        <i class="fas fa-money-bill-wave"></i>
                    </button>
                    ` : ''}
                </div>
                <div class="mt-1">
                    ${item.status === 'paid' ? '<span class="status-paid">‚úÖ ‡§≠‡•Å‡§ó‡§§‡§æ‡§®</span>' : '<span style="color:#dc3545;font-size:12px;">‚ùå ‡§¨‡§ï‡§æ‡§Ø‡§æ</span>'}
                </div>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
    
    // Show message if more data exists
    if (currentData.length > 100) {
        const infoRow = document.createElement('tr');
        infoRow.innerHTML = `
            <td colspan="8" style="text-align: center; padding: 15px; background: #f8f9fa; font-style: italic; color: #666;">
                <i class="fas fa-info-circle"></i>
                ${currentData.length - 100} ‡§î‡§∞ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡•ç‡§∏ ‡§π‡•à‡§Ç‡•§ ‡§∏‡§ü‡•Ä‡§ï ‡§ñ‡•ã‡§ú ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§∞‡•ç‡§ö ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§
            </td>
        `;
        tableBody.appendChild(infoRow);
    }
}

// Also update the search function to search in all relevant fields
function performSearch() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    
    if (!searchTerm) {
        currentData = [...connectionData];
    } else {
        currentData = connectionData.filter(item => 
            (item.con_no && item.con_no.toString().toLowerCase().includes(searchTerm)) ||
            (item.owner_name && item.owner_name.toLowerCase().includes(searchTerm)) ||
            (item.ward_no && item.ward_no.toString().toLowerCase().includes(searchTerm)) ||
            (item.serial_no && item.serial_no.toString().toLowerCase().includes(searchTerm)) ||
            (item.mobile && item.mobile.toString().toLowerCase().includes(searchTerm))
        );
    }
    
    updateStats();
    renderTable();
    
    if (currentData.length === 0 && searchTerm) {
        showMessage(`"${searchTerm}" ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ`, 'error');
    }
}
