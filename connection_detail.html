<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡§ú‡§≤ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® - ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§µ‡§ø‡§µ‡§∞‡§£</title>
<link rel="icon" type="image/png" href="img1.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
/* ---------- Global Styles ---------- */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background-color: #f8f9fa;
    color: #333;
    line-height: 1.6;
}

/* ---------- Header Styles ---------- */
.header {
    background: linear-gradient(135deg, #0066cc, #003d99);
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.logo-container {
    display: flex;
    align-items: center;
    gap: 15px;
}

.logo {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    object-fit: cover;
}

.header h1 {
    font-size: 24px;
    font-weight: 600;
}

.header-buttons {
    display: flex;
    gap: 10px;
}

.header-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 14px;
    transition: background 0.3s;
}

.header-btn:hover {
    background: rgba(255,255,255,0.3);
}

/* ---------- Main Container ---------- */
.container {
    max-width: 1400px;
    margin: 20px auto;
    padding: 0 15px;
}

/* ---------- Search Section ---------- */
.search-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.search-box {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.search-input {
    flex: 1;
    min-width: 300px;
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

.search-btn, .export-btn, .upload-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.search-btn {
    background: #28a745;
    color: white;
}

.export-btn {
    background: #17a2b8;
    color: white;
    text-decoration: none;
}

.upload-btn {
    background: #6f42c1;
    color: white;
}

.search-btn:hover {
    background: #218838;
}

.export-btn:hover {
    background: #138496;
}

.upload-btn:hover {
    background: #5a32a3;
}

/* ---------- Stats Cards ---------- */
.stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.stat-card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    text-align: center;
    border-top: 4px solid #0066cc;
}

.stat-card.connections { border-top-color: #0066cc; }
.stat-card.current { border-top-color: #28a745; }
.stat-card.arrear { border-top-color: #ffc107; }
.stat-card.remaining { border-top-color: #dc3545; }

.stat-card h3 {
    font-size: 14px;
    color: #666;
    margin-bottom: 10px;
}

.stat-card .number {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 5px;
}

.stat-card .icon {
    font-size: 20px;
    margin-bottom: 10px;
}

/* ---------- Table Section ---------- */
.table-section {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-bottom: 30px;
}

.table-container {
    overflow-x: auto;
    max-height: 600px;
    overflow-y: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1000px;
}

.data-table th {
    background: #0066cc;
    color: white;
    padding: 12px 10px;
    text-align: left;
    font-weight: 600;
    font-size: 14px;
    white-space: nowrap;
    position: sticky;
    top: 0;
    z-index: 10;
}

.data-table td {
    padding: 10px;
    border-bottom: 1px solid #eee;
    font-size: 14px;
    vertical-align: middle;
}

.data-table tbody tr:hover {
    background-color: #f0f8ff;
}

/* Column widths */
.data-table th:nth-child(1), .data-table td:nth-child(1) { width: 10%; } /* Connection */
.data-table th:nth-child(2), .data-table td:nth-child(2) { width: 10%; } /* Ward */
.data-table th:nth-child(3), .data-table td:nth-child(3) { width: 25%; } /* Name */
.data-table th:nth-child(4), .data-table td:nth-child(4) { width: 10%; } /* Mobile */
.data-table th:nth-child(5), .data-table td:nth-child(5) { width: 12%; text-align: right; } /* 25-26 */
.data-table th:nth-child(6), .data-table td:nth-child(6) { width: 12%; text-align: right; } /* 24-25 */
.data-table th:nth-child(7), .data-table td:nth-child(7) { width: 12%; text-align: right; } /* Balance */
.data-table th:nth-child(8), .data-table td:nth-child(8) { width: 9%; } /* Status */
.data-table th:nth-child(9), .data-table td:nth-child(9) { width: 10%; } /* Actions */

/* Amount columns alignment */
.amount-col {
    text-align: right !important;
    font-family: monospace;
    font-weight: 600;
}

/* Action Buttons */
.action-buttons {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.action-btn {
    width: 32px;
    height: 32px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    text-decoration: none;
    font-size: 12px;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.edit-btn { background: #007bff; }
.delete-btn { background: #dc3545; }
.print-btn { background: #17a2b8; }
.pay-btn { background: #28a745; }

/* Status Badge */
.status-paid {
    background: #d4edda;
    color: #155724;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    display: inline-block;
}

.status-pending {
    background: #f8d7da;
    color: #721c24;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    display: inline-block;
}

/* ---------- Message Styles ---------- */
.message-box {
    padding: 12px 15px;
    border-radius: 5px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.warning {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

/* ---------- Empty State ---------- */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #666;
    display: none;
}

.empty-state i {
    font-size: 48px;
    color: #ddd;
    margin-bottom: 15px;
}

.empty-state h3 {
    margin-bottom: 10px;
    color: #444;
}

/* ---------- Modal Styles ---------- */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: white;
    width: 90%;
    max-width: 500px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    animation: modalFadeIn 0.3s ease;
}

@keyframes modalFadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

.modal-header {
    background: #dc3545;
    color: white;
    padding: 15px 20px;
    border-radius: 8px 8px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 15px 20px;
    background: #f8f9fa;
    border-radius: 0 0 8px 8px;
    text-align: right;
}

.btn {
    padding: 8px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn:hover:not(:disabled) {
    opacity: 0.9;
}

/* ---------- File Input ---------- */
#csvFileInput {
    display: none;
}

/* ---------- Responsive Design ---------- */
@media (max-width: 768px) {
    .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .search-box {
        flex-direction: column;
    }
    
    .search-input {
        width: 100%;
    }
    
    .stats-container {
        grid-template-columns: 1fr;
    }
    
    .data-table th,
    .data-table td {
        padding: 8px 5px;
        font-size: 12px;
    }
    
    .action-buttons {
        flex-direction: column;
        gap: 3px;
    }
    
    .action-btn {
        width: 28px;
        height: 28px;
        font-size: 10px;
    }
}

@media (max-width: 480px) {
    .container {
        padding: 0 10px;
    }
    
    .header h1 {
        font-size: 20px;
    }
    
    .stat-card .number {
        font-size: 20px;
    }
    
    .data-table {
        font-size: 11px;
    }
}
</style>
</head>
<body>

<!-- Header -->
<header class="header">
    <div class="logo-container">
        <img src="img1.png" alt="Logo" class="logo">
        <h1>‡§ú‡§≤ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® - ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§µ‡§ø‡§µ‡§∞‡§£</h1>
    </div>
    <div class="header-buttons">
        <a href="dashboard.php" class="header-btn">
            <i class="fas fa-home"></i> ‡§π‡•ã‡§Æ
        </a>
        <a href="logout.php" class="header-btn">
            <i class="fas fa-sign-out-alt"></i> ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü
        </a>
    </div>
</header>

<!-- Main Container -->
<div class="container">
    
    <!-- Search Section -->
    <div class="search-section">
        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§®‡§Ç‡§¨‡§∞, ‡§®‡§æ‡§Æ, ‡§µ‡§æ‡§∞‡•ç‡§°, ‡§Ø‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§ñ‡•ã‡§ú‡•á‡§Ç...">
            <button class="search-btn" onclick="performSearch()">
                <i class="fas fa-search"></i> ‡§ñ‡•ã‡§ú‡•á‡§Ç
            </button>
            <button class="export-btn" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i> ‡§è‡§ï‡•ç‡§∏‡•á‡§≤
            </button>
            <button class="upload-btn" onclick="uploadCSV()">
                <i class="fas fa-upload"></i> CSV ‡§Ö‡§™‡§≤‡•ã‡§°
            </button>
            <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
        </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="stats-container">
        <div class="stat-card connections">
            <div class="icon">üë•</div>
            <h3>‡§ï‡•Å‡§≤ ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§®</h3>
            <div class="number" id="totalConnections">0</div>
            <p>‡§∏‡§≠‡•Ä ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§®‡•ã‡§Ç ‡§ï‡•Ä ‡§ï‡•Å‡§≤ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ</p>
        </div>
        
        <div class="stat-card current">
            <div class="icon">üí∞</div>
            <h3>‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§∞‡§æ‡§∂‡§ø</h3>
            <div class="number" id="totalCurrent">‚Çπ0</div>
            <p>2025-26 ‡§µ‡§∞‡•ç‡§∑ ‡§ï‡•Ä ‡§∞‡§æ‡§∂‡§ø</p>
        </div>
        
        <div class="stat-card arrear">
            <div class="icon">üìÖ</div>
            <h3>‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∂‡•á‡§∑</h3>
            <div class="number" id="totalArrear">‚Çπ0</div>
            <p>2024-25 ‡§µ‡§∞‡•ç‡§∑ ‡§ï‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ</p>
        </div>
        
        <div class="stat-card remaining">
            <div class="icon">üßæ</div>
            <h3>‡§∂‡•á‡§∑ ‡§∞‡§æ‡§∂‡§ø</h3>
            <div class="number" id="totalRemaining">‚Çπ0</div>
            <p>‡§∏‡§≠‡•Ä ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§®‡•ã‡§Ç ‡§ï‡§æ ‡§∂‡•á‡§∑</p>
        </div>
    </div>
    
    <!-- Table Section -->
    <div class="table-section">
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§®</th>
                        <th>‡§µ‡§æ‡§∞‡•ç‡§°</th>
                        <th>‡§®‡§æ‡§Æ</th>
                        <th>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</th>
                        <th>2025‚Äë26</th>
                        <th>2024‚Äë25</th>
                        <th>‡§∂‡•á‡§∑</th>
                        <th>‡§∏‡•ç‡§•‡§ø‡§§‡§ø</th>
                        <th>‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Data will be loaded here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Empty State -->
    <div class="empty-state" id="emptyState">
        <i class="fas fa-search"></i>
        <h3>‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</h3>
        <p>‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ CSV ‡§´‡§º‡§æ‡§á‡§≤ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç</p>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle"></i> ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡•á‡§Ç</h3>
            <button onclick="closeModal()" style="background:none;border:none;color:white;font-size:20px;cursor:pointer;">√ó</button>
        </div>
        <div class="modal-body">
            <div style="background:#f8d7da;color:#721c24;padding:10px;border-radius:5px;margin-bottom:15px;">
                <i class="fas fa-exclamation-circle"></i>
                <strong>‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä!</strong> ‡§Ø‡§π ‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à ‡§™‡•Ç‡§∞‡•ç‡§µ‡§µ‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à
            </div>
            
            <div style="padding:15px;background:#f8f9fa;border-radius:5px;margin-bottom:15px;">
                <p style="margin-bottom:10px;">‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?</p>
                <div id="connectionDetails">
                    <!-- Connection details will be inserted here -->
                </div>
            </div>
            
            <div>
                <label for="password" style="display:block;margin-bottom:5px;">‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°</label>
                <div style="position:relative;">
                    <input type="password" id="password" style="width:100%;padding:8px 40px 8px 10px;border:1px solid #ddd;border-radius:5px;" placeholder="‡§Ö‡§™‡§®‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç">
                    <span onclick="togglePassword()" style="position:absolute;right:10px;top:8px;cursor:pointer;">
                        <i class="fas fa-eye"></i>
                    </span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
            <button class="btn btn-danger" id="deleteBtn" disabled onclick="confirmDelete()">‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
        </div>
    </div>
</div>

<script>
// Global variables
let connectionData = [];
let currentData = [];
let currentDeleteConnection = null;

// Format Indian currency
function formatIndianCurrency(amount) {
    if (isNaN(amount) || amount === null || amount === '' || amount === 0) return '‚Çπ0';
    
    amount = parseFloat(amount);
    
    // Format number with commas in Indian style
    let parts = Math.abs(amount).toFixed(0).split('.');
    let wholePart = parts[0];
    
    let lastThree = wholePart.substring(wholePart.length - 3);
    let otherNumbers = wholePart.substring(0, wholePart.length - 3);
    
    if (otherNumbers !== '') {
        lastThree = ',' + lastThree;
    }
    
    let formatted = otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ",") + lastThree;
    
    // Add negative sign if needed
    if (amount < 0) {
        formatted = '-' + formatted;
    }
    
    return '‚Çπ' + formatted;
}

// Extract amount from string
function extractAmount(str) {
    if (!str) return 0;
    
    // Remove non-numeric characters except decimal point
    str = str.toString().replace(/[^\d.-]/g, '');
    
    // Parse as float
    const amount = parseFloat(str);
    return isNaN(amount) ? 0 : amount;
}

// Parse CSV data
function parseCSV(csvText) {
    const rows = csvText.split('\n');
    const data = [];
    
    // Skip header row (first row)
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i].trim();
        if (!row) continue;
        
        // Handle quoted fields properly
        const columns = [];
        let currentColumn = '';
        let inQuotes = false;
        
        for (let j = 0; j < row.length; j++) {
            const char = row[j];
            
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                columns.push(currentColumn.trim());
                currentColumn = '';
            } else {
                currentColumn += char;
            }
        }
        columns.push(currentColumn.trim()); // Add last column
        
        // Your CSV has 9 columns
        if (columns.length >= 9) {
            const currentAmount = extractAmount(columns[6] || '600');
            const arrearAmount = extractAmount(columns[7] || '0');
            const totalAmount = extractAmount(columns[8] || '0') || (currentAmount + arrearAmount);
            
            const connection = {
                con_no: columns[0] || '',
                ward_no: columns[1] || '',
                owner_name: columns[2] || '',
                mobile: columns[5] || '',
                current_2025_26: currentAmount,
                arrear_2024_25: arrearAmount,
                total_balance: totalAmount,
                status: totalAmount === 0 ? 'paid' : 'pending',
                house_no: columns[3] || '',
                old_house_no: columns[4] || ''
            };
            
            data.push(connection);
        }
    }
    
    return data;
}

// Load CSV data
async function loadCSVData() {
    try {
        const csvFiles = [
            'connection_data.csv',
            'connections.csv',
            'data.csv',
            'bills.csv',
            'connection_details.csv'
        ];
        
        let csvLoaded = false;
        
        for (const csvFile of csvFiles) {
            try {
                const response = await fetch(csvFile);
                if (response.ok) {
                    const csvText = await response.text();
                    connectionData = parseCSV(csvText);
                    currentData = [...connectionData];
                    
                    updateStats();
                    renderTable();
                    csvLoaded = true;
                    
                    showMessage(`CSV ‡§´‡§º‡§æ‡§á‡§≤ ‡§≤‡•ã‡§° ‡§π‡•Å‡§à: ${connectionData.length} ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§®`, 'success');
                    break;
                }
            } catch (error) {
                console.log(`Failed to load ${csvFile}:`, error);
            }
        }
        
        if (!csvLoaded) {
            throw new Error('No CSV file found');
        }
    } catch (error) {
        console.error('Error loading CSV:', error);
        loadSampleData();
    }
}

// Load sample data
function loadSampleData() {
    connectionData = [
        {
            con_no: '1034',
            ward_no: '23-‡§ö‡•å‡§ß‡§∞‡•Ä‡§Ø‡§æ‡§®',
            owner_name: '‡§∂‡•ç‡§∞‡•Ä ‡§∞‡§ï‡§Æ ‡§∏‡§ø‡§Ç‡§π s/o ‡§∂‡•ç‡§∞‡•Ä ‡§π‡•Ä‡§∞‡§æ',
            mobile: '9927191983',
            current_2025_26: 600,
            arrear_2024_25: 1800,
            total_balance: 2400,
            status: 'pending'
        },
        {
            con_no: '1000',
            ward_no: '15-‡§∏‡§æ‡§¶‡§≤‡§ó‡§Ç‡§ú',
            owner_name: '‡§∂‡•ç‡§∞‡•Ä ‡§∂‡§ï‡•Ç‡§∞ ‡§Ö‡§π‡§Æ‡§¶ s/o ‡§∂‡•ç‡§∞‡•Ä ‡§ï‡•Å‡•ú‡§æ',
            mobile: '8923035159',
            current_2025_26: 600,
            arrear_2024_25: 5920,
            total_balance: 6520,
            status: 'pending'
        },
        {
            con_no: '1',
            ward_no: '10-‡§∏‡§∞‡•ã‡§ú‡•ç‡§û‡§æ‡§®',
            owner_name: '‡§∂‡•ç‡§∞‡•Ä ‡§®‡•á‡§Æ‡§ö‡§®‡•ç‡§¶ ‡§™‡•Å‡§§‡•ç‡§∞ ‡§∂‡•ç‡§∞‡•Ä ‡§∞‡§æ‡§Æ‡§™‡•ç‡§∞‡§∏‡§æ‡§¶',
            mobile: '',
            current_2025_26: 600,
            arrear_2024_25: 2850,
            total_balance: 3450,
            status: 'pending'
        },
        {
            con_no: '3',
            ward_no: '14-‡§Ö‡§´‡§ó‡§æ‡§®‡§æ‡§®',
            owner_name: '‡§∂‡•ç‡§∞‡•Ä ‡§ï‡•å‡§∂‡§≤ ‡§™‡•ç‡§∞‡§∏‡§æ‡§¶ ‡§™‡•Å‡§§‡•ç‡§∞ ‡§∂‡•ç‡§∞‡•Ä ‡§¨‡•Å‡§≤‡§ö‡§Ç‡§¶',
            mobile: '',
            current_2025_26: 600,
            arrear_2024_25: 0,
            total_balance: 600,
            status: 'paid'
        },
        {
            con_no: '100',
            ward_no: '24-‡§¨‡§®‡•ç‡§ú‡§æ‡§∞‡§æ‡§®',
            owner_name: '‡§∂‡•ç‡§∞‡•Ä ‡§Æ‡•ã‡§§‡•Ä‡§∏‡§æ‡§ó‡§∞ s/o ‡§∂‡•ç‡§∞‡•Ä ‡§ï‡•Å‡§≤‡§µ‡§®‡•ç‡§§‡§∞‡§æ‡§Ø ‡§ú‡•à‡§®',
            mobile: '',
            current_2025_26: 600,
            arrear_2024_25: 0,
            total_balance: 600,
            status: 'paid'
        }
    ];
    
    currentData = [...connectionData];
    updateStats();
    renderTable();
    
    showMessage('CSV ‡§´‡§º‡§æ‡§á‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä, ‡§∏‡•à‡§Ç‡§™‡§≤ ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ', 'warning');
}

// Update statistics
function updateStats() {
    const totalConnections = currentData.length;
    const totalCurrent = currentData.reduce((sum, item) => sum + (item.current_2025_26 || 0), 0);
    const totalArrear = currentData.reduce((sum, item) => sum + (item.arrear_2024_25 || 0), 0);
    const totalRemaining = currentData.reduce((sum, item) => sum + (item.total_balance || 0), 0);
    
    document.getElementById('totalConnections').textContent = totalConnections.toLocaleString('hi-IN');
    document.getElementById('totalCurrent').textContent = formatIndianCurrency(totalCurrent);
    document.getElementById('totalArrear').textContent = formatIndianCurrency(totalArrear);
    document.getElementById('totalRemaining').textContent = formatIndianCurrency(totalRemaining);
}

// Render table
function renderTable() {
    const tableBody = document.getElementById('tableBody');
    const emptyState = document.getElementById('emptyState');
    
    if (currentData.length === 0) {
        tableBody.innerHTML = '';
        emptyState.style.display = 'block';
        emptyState.innerHTML = `
            <i class="fas fa-inbox"></i>
            <h3>‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</h3>
            <p>‡§ï‡•É‡§™‡§Ø‡§æ CSV ‡§´‡§º‡§æ‡§á‡§≤ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§∏‡§∞‡•ç‡§ö ‡§ü‡§∞‡•ç‡§Æ ‡§¨‡§¶‡§≤‡•á‡§Ç</p>
        `;
        return;
    }
    
    emptyState.style.display = 'none';
    
    let tableHTML = '';
    
    currentData.forEach((item, index) => {
        // Format mobile - show only if not 0
        const mobileDisplay = (item.mobile === '0' || !item.mobile) ? '' : item.mobile;
        
        tableHTML += `
            <tr>
                <td>${item.con_no || ''}</td>
                <td>${item.ward_no || ''}</td>
                <td title="${item.owner_name || ''}">${item.owner_name || ''}</td>
                <td>${mobileDisplay}</td>
                <td class="amount-col">${formatIndianCurrency(item.current_2025_26)}</td>
                <td class="amount-col">${formatIndianCurrency(item.arrear_2024_25)}</td>
                <td class="amount-col">${formatIndianCurrency(item.total_balance)}</td>
                <td>
                    ${item.status === 'paid' ? 
                        '<span class="status-paid">‚úÖ ‡§≠‡•Å‡§ó‡§§‡§æ‡§®</span>' : 
                        '<span class="status-pending">‚ùå ‡§¨‡§ï‡§æ‡§Ø‡§æ</span>'}
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn edit-btn" onclick="editConnection('${item.con_no}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" onclick="showDeleteModal('${item.con_no}', '${item.owner_name}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="action-btn print-btn" onclick="printBill('${item.con_no}')" title="Print">
                            <i class="fas fa-print"></i>
                        </button>
                        ${item.total_balance > 0 ? `
                        <button class="action-btn pay-btn" onclick="makePayment('${item.con_no}')" title="Pay">
                            <i class="fas fa-rupee-sign"></i>
                        </button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `;
    });
    
    tableBody.innerHTML = tableHTML;
}

// Show message
function showMessage(message, type = 'info') {
    // Remove existing message
    const existingMsg = document.querySelector('.message-box');
    if (existingMsg) existingMsg.remove();
    
    const messageBox = document.createElement('div');
    messageBox.className = `message-box ${type}`;
    messageBox.innerHTML = `
        <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 
                          type === 'warning' ? 'exclamation-triangle' : 'check-circle'}"></i>
        ${message}
    `;
    
    const container = document.querySelector('.container');
    const searchSection = document.querySelector('.search-section');
    container.insertBefore(messageBox, searchSection.nextElementSibling);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        messageBox.style.opacity = '0';
        messageBox.style.transition = 'opacity 0.5s ease-out';
        setTimeout(() => {
            if (messageBox.parentNode) {
                messageBox.parentNode.removeChild(messageBox);
            }
        }, 500);
    }, 5000);
}

// Search function
function performSearch() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    
    if (!searchTerm) {
        currentData = [...connectionData];
    } else {
        currentData = connectionData.filter(item => 
            (item.con_no && item.con_no.toString().toLowerCase().includes(searchTerm)) ||
            (item.owner_name && item.owner_name.toLowerCase().includes(searchTerm)) ||
            (item.mobile && item.mobile.toString().includes(searchTerm)) ||
            (item.ward_no && item.ward_no.toString().toLowerCase().includes(searchTerm))
        );
    }
    
    updateStats();
    renderTable();
    
    if (currentData.length === 0 && searchTerm) {
        showMessage(`"${searchTerm}" ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ`, 'error');
    }
}

// Export to Excel
function exportToExcel() {
    if (currentData.length === 0) {
        showMessage('‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à', 'error');
        return;
    }
    
    // Create CSV content
    let csvContent = "‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§®,‡§µ‡§æ‡§∞‡•ç‡§°,‡§®‡§æ‡§Æ,‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤,2025-26,2024-25,‡§∂‡•á‡§∑,‡§∏‡•ç‡§•‡§ø‡§§‡§ø\n";
    
    currentData.forEach(item => {
        csvContent += `"${item.con_no}","${item.ward_no}","${item.owner_name}","${item.mobile}",${item.current_2025_26},${item.arrear_2024_25},${item.total_balance},"${item.status === 'paid' ? '‡§≠‡•Å‡§ó‡§§‡§æ‡§®' : '‡§¨‡§ï‡§æ‡§Ø‡§æ'}"\n`;
    });
    
    // Create download link
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `connection_details_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showMessage('‡§è‡§ï‡•ç‡§∏‡•á‡§≤ ‡§´‡§º‡§æ‡§á‡§≤ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§ ‡§π‡•Å‡§à', 'success');
}

// Upload CSV
function uploadCSV() {
    document.getElementById('csvFileInput').click();
}

// Handle CSV file upload
document.getElementById('csvFileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const csvText = event.target.result;
            connectionData = parseCSV(csvText);
            currentData = [...connectionData];
            updateStats();
            renderTable();
            showMessage(`CSV ‡§´‡§º‡§æ‡§á‡§≤ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≤‡•ã‡§° ‡§π‡•Å‡§à: ${connectionData.length} ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§®`, 'success');
            
            // Reset file input
            document.getElementById('csvFileInput').value = '';
        };
        reader.onerror = function() {
            showMessage('CSV ‡§´‡§º‡§æ‡§á‡§≤ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', 'error');
            document.getElementById('csvFileInput').value = '';
        };
        reader.readAsText(file);
    }
});

// Edit Connection
function editConnection(conNo) {
    const connection = currentData.find(item => item.con_no === conNo);
    if (connection) {
        alert(`‡§è‡§°‡§ø‡§ü ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç:\n\n‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§®: ${connection.con_no}\n‡§®‡§æ‡§Æ: ${connection.owner_name}\n\n2025-26: ${formatIndianCurrency(connection.current_2025_26)}\n2024-25: ${formatIndianCurrency(connection.arrear_2024_25)}\n‡§ï‡•Å‡§≤: ${formatIndianCurrency(connection.total_balance)}`);
        // window.location.href = `edit_connection.php?id=${conNo}`;
    }
}

// Show Delete Modal
function showDeleteModal(conNo, ownerName) {
    currentDeleteConnection = conNo;
    
    document.getElementById('connectionDetails').innerHTML = `
        <p><strong>‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§®‡§Ç‡§¨‡§∞:</strong> ${conNo}</p>
        <p><strong>‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ:</strong> ${ownerName}</p>
    `;
    
    document.getElementById('deleteModal').style.display = 'flex';
    document.getElementById('password').value = '';
    document.getElementById('deleteBtn').disabled = true;
}

// Close Modal
function closeModal() {
    document.getElementById('deleteModal').style.display = 'none';
    currentDeleteConnection = null;
}

// Toggle password visibility
function togglePassword() {
    const passwordInput = document.getElementById('password');
    const icon = document.querySelector('#deleteModal .fa-eye');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        passwordInput.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Enable delete button when password is entered
document.getElementById('password').addEventListener('input', function() {
    document.getElementById('deleteBtn').disabled = this.value.trim() === '';
});

// Confirm Delete
function confirmDelete() {
    const password = document.getElementById('password').value;
    if (password === 'admin123') {
        // Remove from connectionData
        const index = connectionData.findIndex(item => item.con_no === currentDeleteConnection);
        if (index > -1) {
            connectionData.splice(index, 1);
        }
        
        // Remove from currentData
        const currentIndex = currentData.findIndex(item => item.con_no === currentDeleteConnection);
        if (currentIndex > -1) {
            currentData.splice(currentIndex, 1);
        }
        
        // Update UI
        updateStats();
        renderTable();
        
        // Close modal
        closeModal();
        
        // Show success message
        showMessage('‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ!', 'success');
    } else {
        showMessage('‚ùå ‡§ó‡§≤‡§§ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°!', 'error');
    }
}

// Print Bill
function printBill(conNo) {
    const connection = currentData.find(item => item.con_no === conNo);
    if (connection) {
        const billContent = `
            ====================================
                    ‡§ú‡§≤ ‡§¨‡§ø‡§≤ - NPP ‡§®‡§ï‡•Å‡§∞
            ====================================
            
            ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§®‡§Ç‡§¨‡§∞: ${connection.con_no}
            ‡§µ‡§æ‡§∞‡•ç‡§°: ${connection.ward_no}
            ‡§®‡§æ‡§Æ: ${connection.owner_name}
            ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤: ${connection.mobile}
            
            ------------------------------------
                   ‡§¨‡§ø‡§≤ ‡§µ‡§ø‡§µ‡§∞‡§£
            ------------------------------------
            2025-26 ‡§ï‡•Ä ‡§∞‡§æ‡§∂‡§ø: ${formatIndianCurrency(connection.current_2025_26)}
            2024-25 ‡§ï‡§æ ‡§¨‡§ï‡§æ‡§Ø‡§æ: ${formatIndianCurrency(connection.arrear_2024_25)}
            
            ------------------------------------
            ‡§ï‡•Å‡§≤ ‡§¶‡•á‡§Ø ‡§∞‡§æ‡§∂‡§ø: ${formatIndianCurrency(connection.total_balance)}
            ------------------------------------
            
            ‡§ú‡§æ‡§∞‡•Ä ‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï: ${new Date().toLocaleDateString('hi-IN')}
            ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡•Ä ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§§‡§ø‡§•‡§ø: 31-03-2026
        `;
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
            <head>
                <title>‡§ú‡§≤ ‡§¨‡§ø‡§≤ - ${connection.con_no}</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    pre { font-family: monospace; font-size: 14px; white-space: pre-wrap; }
                </style>
            </head>
            <body>
                <pre>${billContent}</pre>
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }
}

// Make Payment
function makePayment(conNo) {
    const connection = currentData.find(item => item.con_no === conNo);
    if (connection) {
        alert(`‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç:\n\n‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§®: ${connection.con_no}\n‡§®‡§æ‡§Æ: ${connection.owner_name}\n\n‡§ï‡•Å‡§≤ ‡§¨‡§ï‡§æ‡§Ø‡§æ: ${formatIndianCurrency(connection.total_balance)}\n\n‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§™‡•á‡§ú ‡§™‡§∞ ‡§∞‡•Ä‡§°‡§æ‡§Ø‡§∞‡•á‡§ï‡•ç‡§ü ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...`);
        // window.open(`payment.php?con=${conNo}&amount=${connection.total_balance}`, '_blank');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load CSV data
    loadCSVData();
    
    // Add Enter key support for search
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });
    
    // Close modal when clicking outside
    document.getElementById('deleteModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
});
</script>
</body>
</html>
