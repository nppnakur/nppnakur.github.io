<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>नया जल कनेक्शन</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        /* पूरा CSS कोड यहाँ रहेगा (ऊपर जैसा ही) */
    </style>
</head>
<body>

<div class="header">
    <div><strong><i class="fas fa-water" style="color: #1565c0;"></i> नया जल कनेक्शन</strong></div>
    <div style="display: flex;">
        <a href="dashboard.html"><i class="fas fa-home"></i> होम</a>
        <a href="index.html"><i class="fas fa-sign-out-alt"></i> लॉगआउट</a>
    </div>
</div>

<div class="main-container">
    <form method="POST" class="form-container" id="connectionForm">
        <!-- PHP कोड हटा दें और सीधे HTML रखें -->
        <div class="error-message full-width" id="errorMessage" style="display:none;">
            <i class="fas fa-exclamation-circle"></i>
            <span id="errorText"></span>
        </div>

        <div class="success-message full-width" id="successMessage" style="display:none;">
            <i class="fas fa-check-circle"></i>
            <span id="successText"></span>
        </div>

        <!-- फॉर्म फ़ील्ड्स यहाँ रहेंगे (PHP कोड हटाकर) -->
        <div class="form-group">
            <label for="con_no" class="required"><i class="fas fa-id-card"></i> कनेक्शन नंबर</label>
            <input type="text" id="con_no" name="con_no" required
                   placeholder="जैसे: JL12345" pattern="[A-Za-z0-9]{3,15}"
                   title="केवल अक्षर और संख्याएं (3-15 अक्षर)"
                   maxlength="15">
        </div>

        <!-- बाकी सभी फ़ील्ड्स... -->

        <div class="form-group full-width">
            <button type="submit" class="submit-btn">
                <i class="fas fa-save"></i> कनेक्शन सहेजें
            </button>
        </div>
    </form>

    <button onclick="window.location.href='water_manegment.html'" class="bottom-center-btn">
        <i class="fas fa-arrow-left"></i> सूची पर वापस जाएं
    </button>
</div>

<script>
    // PHP सेशन के बजाय localStorage का उपयोग करें
    function checkLogin() {
        const username = localStorage.getItem('username');
        if (!username) {
            window.location.href = 'index.html';
            return false;
        }
        return true;
    }

    // पेज लोड होने पर लॉगिन चेक करें
    document.addEventListener('DOMContentLoaded', function() {
        if (!checkLogin()) return;
        
        // वर्तमान तिथि और समय सेट करें
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        
        document.getElementById("connection_date_time").value = 
            `${year}-${month}-${day}T${hours}:${minutes}`;

        // URL से error/success मैसेज चेक करें
        const urlParams = new URLSearchParams(window.location.search);
        const error = urlParams.get('error');
        const success = urlParams.get('success');
        
        if (error) {
            document.getElementById('errorText').textContent = error;
            document.getElementById('errorMessage').style.display = 'flex';
        }
        
        if (success) {
            document.getElementById('successText').textContent = success;
            document.getElementById('successMessage').style.display = 'flex';
        }
    });

    // फॉर्म सबमिशन हैंडलर
    document.getElementById('connectionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!validateForm()) {
            return false;
        }
        
        // फॉर्म डेटा एकत्र करें
        const formData = {
            con_no: document.getElementById('con_no').value,
            owner: document.getElementById('owner').value,
            mobile: document.getElementById('mobile').value,
            ward_no: document.getElementById('ward_no').value,
            connection_type: document.getElementById('connection_type').value,
            current_amount: document.getElementById('current_amount').value,
            arrear_balance: document.getElementById('arrear_balance').value,
            connection_date_time: document.getElementById('connection_date_time').value,
            total_amount: document.getElementById('totalAmount').textContent
        };
        
        // localStorage में डेटा सहेजें
        saveToLocalStorage(formData);
        
        // सफलता संदेश दिखाएं
        document.getElementById('successText').textContent = 'कनेक्शन सफलतापूर्वक सहेजा गया!';
        document.getElementById('successMessage').style.display = 'flex';
        document.getElementById('errorMessage').style.display = 'none';
        
        // फॉर्म रीसेट करें
        setTimeout(() => {
            window.location.href = 'jal.html?success=कनेक्शन सफलतापूर्वक सहेजा गया';
        }, 1500);
    });

    function saveToLocalStorage(data) {
        // मौजूदा कनेक्शन प्राप्त करें
        let connections = JSON.parse(localStorage.getItem('water_connections') || '[]');
        
        // नया कनेक्शन जोड़ें
        data.id = Date.now(); // यूनिक ID
        data.created_at = new Date().toISOString();
        connections.push(data);
        
        // localStorage में सहेजें
        localStorage.setItem('water_connections', JSON.stringify(connections));
        
        // कॉन्सोल में डीबग के लिए
        console.log('कनेक्शन सहेजा गया:', data);
    }

    // बाकी JavaScript फंक्शन (calculateTotal, validateForm, etc.) वही रहेंगे
    function calculateTotal() {
        const curr = parseFloat(document.getElementById("current_amount").value) || 0;
        const arrear = parseFloat(document.getElementById("arrear_balance").value) || 0;
        const total = curr + arrear;
        document.getElementById("totalAmount").textContent = total.toFixed(2);
    }

    function validateForm() {
        const mobile = document.getElementById('mobile').value;
        const conNo = document.getElementById('con_no').value;
        const owner = document.getElementById('owner').value;
        
        // मोबाइल नंबर validation
        if (!/^[6-9][0-9]{9}$/.test(mobile)) {
            showError('कृपया वैध 10 अंकों का भारतीय मोबाइल नंबर दर्ज करें (6, 7, 8 या 9 से शुरू)');
            return false;
        }
        
        // कनेक्शन नंबर validation
        if (!/^[A-Za-z0-9]{3,15}$/.test(conNo)) {
            showError('कनेक्शन नंबर 3-15 अक्षरों का होना चाहिए और केवल अक्षर एवं संख्याएं हो सकती हैं');
            return false;
        }
        
        // नाम validation
        if (!/^[a-zA-Z\u0900-\u097F\s]{3,50}$/.test(owner)) {
            showError('नाम 3-50 अक्षरों का होना चाहिए और केवल अक्षर हो सकते हैं');
            return false;
        }
        
        // तिथि validation
        const dateInput = document.getElementById('connection_date_time');
        const selectedDate = new Date(dateInput.value);
        const currentDate = new Date();
        
        if (selectedDate > currentDate) {
            showError('कनेक्शन की तिथि भविष्य में नहीं हो सकती');
            return false;
        }
        
        return true;
    }

    function showError(message) {
        document.getElementById('errorText').textContent = message;
        document.getElementById('errorMessage').style.display = 'flex';
        document.getElementById('successMessage').style.display = 'none';
    }
</script>

</body>
</html>

